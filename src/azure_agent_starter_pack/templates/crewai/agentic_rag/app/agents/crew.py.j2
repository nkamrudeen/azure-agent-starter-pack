"""CrewAI crew: multi-agent workflow with tasks and tools."""

import os

from crewai import Agent, Crew, Process, Task
from langchain_openai import AzureChatOpenAI

from app.tools.search_tool import SearchTool


def _get_llm() -> AzureChatOpenAI:
    return AzureChatOpenAI(
        azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT", ""),
        azure_deployment=os.getenv("AZURE_OPENAI_DEPLOYMENT", "gpt-4o"),
        api_version=os.getenv("AZURE_OPENAI_API_VERSION", "2024-12-01-preview"),
    )


def build_crew() -> Crew:
    """Build a crew with research and summariser agents."""
    llm = _get_llm()

    researcher = Agent(
        role="Researcher",
        goal="Find accurate, relevant information about {query}",
        backstory="You are an expert researcher with access to knowledge sources.",
        tools=[SearchTool()],
        llm=llm,
        verbose=True,
    )

    summariser = Agent(
        role="Summariser",
        goal="Produce a clear, concise summary with key takeaways",
        backstory="You are a technical writer who excels at distilling complex information.",
        llm=llm,
        verbose=True,
    )

    research_task = Task(
        description="Research the following topic thoroughly: {query}",
        expected_output="A detailed research report with sources and key findings.",
        agent=researcher,
    )

    summarise_task = Task(
        description="Summarise the research findings into a concise report.",
        expected_output="A 2-3 paragraph summary with key takeaways and action items.",
        agent=summariser,
    )

    return Crew(
        agents=[researcher, summariser],
        tasks=[research_task, summarise_task],
        process=Process.sequential,
        verbose=True,
    )
