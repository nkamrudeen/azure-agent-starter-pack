"""Entrypoint: FastAPI app serving the Google ADK agent."""

import os
import sys
from pathlib import Path

# Ensure project root is on sys.path so `app.*` imports work regardless of how this file is invoked.
sys.path.insert(0, str(Path(__file__).resolve().parent.parent))

from dotenv import load_dotenv

load_dotenv()

# Configure Azure OpenAI auth (API key or Managed Identity) before agent
# modules are imported, since they call get_model() at module level.
if os.getenv("AZURE_OPENAI_DEPLOYMENT"):
    from app.azure_openai import setup_azure_openai

    setup_azure_openai()

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles

from app.agents.root_agent import root_agent

app = FastAPI(title="{{ project_name }}", version="0.1.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173", os.getenv("FRONTEND_URL", "")],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Serve React build in production
frontend_build = Path(__file__).parent.parent / "frontend" / "dist"
if frontend_build.is_dir():
    app.mount("/", StaticFiles(directory=str(frontend_build), html=True), name="frontend")


@app.get("/health")
async def health():
    return {"status": "ok"}


@app.post("/run")
async def run_agent(query: dict):
    """Execute the root agent with the given query."""
    from google.adk.runners import Runner
    from google.adk.sessions import InMemorySessionService

    session_service = InMemorySessionService()
    runner = Runner(agent=root_agent, app_name="{{ project_name }}", session_service=session_service)

    session = await session_service.create_session(app_name="{{ project_name }}", user_id="user")
    from google.genai.types import Content, Part

    user_message = Content(parts=[Part(text=query.get("message", ""))])

    response_parts = []
    async for event in runner.run_async(
        user_id="user", session_id=session.id, new_message=user_message
    ):
        if event.is_final_response() and event.content and event.content.parts:
            for part in event.content.parts:
                if part.text:
                    response_parts.append(part.text)

    return {"response": "\n".join(response_parts)}


# Serve React build in production (must be after API routes)
frontend_build = Path(__file__).parent.parent / "frontend" / "dist"
if frontend_build.is_dir():
    app.mount("/", StaticFiles(directory=str(frontend_build), html=True), name="frontend")


if __name__ == "__main__":
    import uvicorn

    uvicorn.run("app.main:app", host="0.0.0.0", port=int(os.getenv("PORT", "8000")), reload=True)
