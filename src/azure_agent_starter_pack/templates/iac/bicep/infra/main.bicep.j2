targetScope = 'resourceGroup'

@description('Azure region')
param location string = resourceGroup().location

@description('Environment name')
@allowed(['dev', 'stage', 'prod'])
param environment string = 'dev'

@description('Project name used for resource naming')
param projectName string = '{{ project_name | replace("_", "-") }}'

@description('Tags applied to all resources')
param tags object = {
  project: projectName
  environment: environment
  managed_by: 'bicep'
}

// ---------- Container Registry ----------

resource acr 'Microsoft.ContainerRegistry/registries@2023-07-01' = {
  name: replace('${projectName}${environment}acr', '-', '')
  location: location
  sku: { name: 'Standard' }
  properties: { adminUserEnabled: false }
  tags: tags
}

// ---------- Key Vault ----------

resource keyVault 'Microsoft.KeyVault/vaults@2023-07-01' = {
  name: '${projectName}-${environment}-kv'
  location: location
  properties: {
    tenantId: subscription().tenantId
    sku: { family: 'A', name: 'standard' }
    enableRbacAuthorization: true
    enableSoftDelete: true
    softDeleteRetentionInDays: 7
    enablePurgeProtection: true
  }
  tags: tags
}

// ---------- Log Analytics ----------

resource logAnalytics 'Microsoft.OperationalInsights/workspaces@2023-09-01' = {
  name: '${projectName}-${environment}-logs'
  location: location
  properties: {
    sku: { name: 'PerGB2018' }
    retentionInDays: 30
  }
  tags: tags
}

{% if runtime == "aks" %}
// ---------- AKS ----------

resource aks 'Microsoft.ContainerService/managedClusters@2024-01-01' = {
  name: '${projectName}-${environment}-aks'
  location: location
  identity: { type: 'SystemAssigned' }
  properties: {
    dnsPrefix: '${projectName}-${environment}'
    agentPoolProfiles: [
      {
        name: 'default'
        count: 2
        vmSize: 'Standard_D2s_v3'
        mode: 'System'
      }
    ]
    addonProfiles: {
      omsagent: {
        enabled: true
        config: { logAnalyticsWorkspaceResourceID: logAnalytics.id }
      }
    }
  }
  tags: tags
}
{% endif %}

{% if runtime == "container_apps" %}
// ---------- Container Apps ----------

resource cae 'Microsoft.App/managedEnvironments@2024-03-01' = {
  name: '${projectName}-${environment}-cae'
  location: location
  properties: {
    appLogsConfiguration: {
      destination: 'log-analytics'
      logAnalyticsConfiguration: {
        customerId: logAnalytics.properties.customerId
        sharedKey: logAnalytics.listKeys().primarySharedKey
      }
    }
  }
  tags: tags
}

resource containerApp 'Microsoft.App/containerApps@2024-03-01' = {
  name: '${projectName}-${environment}'
  location: location
  identity: { type: 'SystemAssigned' }
  properties: {
    managedEnvironmentId: cae.id
    configuration: {
      ingress: {
        external: true
        targetPort: 8000
        transport: 'http'
      }
    }
    template: {
      containers: [
        {
          name: projectName
          image: '${acr.properties.loginServer}/${projectName}:latest'
          resources: { cpu: json('0.5'), memory: '1Gi' }
          env: [
            { name: 'KEY_VAULT_URL', value: keyVault.properties.vaultUri }
            { name: 'ENVIRONMENT', value: environment }
          ]
        }
      ]
    }
  }
  tags: tags
}
{% endif %}

{% if runtime == "app_service" %}
// ---------- App Service ----------

resource appServicePlan 'Microsoft.Web/serverfarms@2023-12-01' = {
  name: '${projectName}-${environment}-plan'
  location: location
  kind: 'linux'
  sku: { name: 'B1', tier: 'Basic' }
  properties: { reserved: true }
  tags: tags
}

resource webApp 'Microsoft.Web/sites@2023-12-01' = {
  name: '${projectName}-${environment}'
  location: location
  identity: { type: 'SystemAssigned' }
  properties: {
    serverFarmId: appServicePlan.id
    siteConfig: {
      linuxFxVersion: 'DOCKER|${acr.properties.loginServer}/${projectName}:latest'
      appSettings: [
        { name: 'KEY_VAULT_URL', value: keyVault.properties.vaultUri }
        { name: 'ENVIRONMENT', value: environment }
        { name: 'WEBSITES_ENABLE_APP_SERVICE_STORAGE', value: 'false' }
      ]
    }
  }
  tags: tags
}
{% endif %}

// ---------- Outputs ----------

output acrLoginServer string = acr.properties.loginServer
output keyVaultUri string = keyVault.properties.vaultUri
{% if runtime == "aks" %}
output aksClusterName string = aks.name
{% endif %}
{% if runtime == "container_apps" %}
output containerAppFqdn string = containerApp.properties.configuration.ingress.fqdn
{% endif %}
{% if runtime == "app_service" %}
output appServiceUrl string = 'https://${webApp.properties.defaultHostName}'
{% endif %}
