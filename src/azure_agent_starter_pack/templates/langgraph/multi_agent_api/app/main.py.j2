"""Entrypoint: FastAPI app serving the LangGraph agent."""

import os
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).resolve().parent.parent))

from dotenv import load_dotenv
from fastapi import FastAPI

load_dotenv()

app = FastAPI(title="{{ project_name }}", version="0.1.0")


@app.get("/health")
async def health():
    return {"status": "ok"}


@app.post("/run")
async def run_agent(query: dict):
    """Execute the LangGraph workflow with the given query."""
    from app.agents.graph import build_graph

    graph = build_graph()
    result = await graph.ainvoke({"messages": [("user", query.get("message", ""))]})
    last_message = result["messages"][-1]
    return {"response": last_message.content if hasattr(last_message, "content") else str(last_message)}


if __name__ == "__main__":
    import uvicorn

    uvicorn.run("app.main:app", host="0.0.0.0", port=int(os.getenv("PORT", "8000")), reload=True)
