"""Indexer: push documents into Azure AI Search with vector embeddings."""

import hashlib
import json

from azure.identity import DefaultAzureCredential
from azure.search.documents import SearchClient
from azure.search.documents.indexes import SearchIndexClient
from azure.search.documents.indexes.models import (
    HnswAlgorithmConfiguration,
    SearchableField,
    SearchField,
    SearchFieldDataType,
    SearchIndex,
    SimpleField,
    VectorSearch,
    VectorSearchProfile,
)

from app.rag.config import (
    AZURE_AI_SEARCH_ENDPOINT,
    AZURE_AI_SEARCH_INDEX,
)
from app.rag.embedder import embed_texts


def _get_credential():
    return DefaultAzureCredential()


def ensure_index() -> None:
    """Create or update the search index with vector fields."""
    credential = _get_credential()
    client = SearchIndexClient(
        endpoint=AZURE_AI_SEARCH_ENDPOINT,
        credential=credential,
    )

    fields = [
        SimpleField(name="id", type=SearchFieldDataType.String, key=True, filterable=True),
        SearchableField(name="content", type=SearchFieldDataType.String),
        SimpleField(name="metadata", type=SearchFieldDataType.String),
        SearchField(
            name="content_vector",
            type=SearchFieldDataType.Collection(SearchFieldDataType.Single),
            searchable=True,
            vector_search_dimensions=1536,
            vector_search_profile_name="default-profile",
        ),
    ]

    vector_search = VectorSearch(
        algorithms=[HnswAlgorithmConfiguration(name="default-hnsw")],
        profiles=[VectorSearchProfile(name="default-profile", algorithm_configuration_name="default-hnsw")],
    )

    index = SearchIndex(
        name=AZURE_AI_SEARCH_INDEX,
        fields=fields,
        vector_search=vector_search,
    )
    client.create_or_update_index(index)
    print(f"Index '{AZURE_AI_SEARCH_INDEX}' created/updated.")


def index_chunks(chunks: list[dict]) -> int:
    """Index chunked documents with embeddings into Azure AI Search.

    Returns the number of documents indexed.
    """
    credential = _get_credential()
    client = SearchClient(
        endpoint=AZURE_AI_SEARCH_ENDPOINT,
        index_name=AZURE_AI_SEARCH_INDEX,
        credential=credential,
    )

    texts = [c["content"] for c in chunks]
    vectors = embed_texts(texts)

    docs = []
    for chunk, vector in zip(chunks, vectors):
        doc_id = hashlib.sha256(chunk["content"].encode()).hexdigest()[:32]
        docs.append({
            "id": doc_id,
            "content": chunk["content"],
            "metadata": json.dumps(chunk.get("metadata", {})),
            "content_vector": vector,
        })

    result = client.upload_documents(documents=docs)
    succeeded = sum(1 for r in result if r.succeeded)
    print(f"Indexed {succeeded}/{len(docs)} documents.")
    return succeeded
