"""Orchestrator agent: coordinates specialist agents via Azure AI Foundry."""

import os

from azure.ai.projects import AIProjectClient
from azure.ai.projects.models import AgentThread, MessageRole
from azure.identity import DefaultAzureCredential

PROJECT_CONN_STR = os.getenv("AZURE_AI_PROJECT_CONNECTION_STRING", "")


def _get_client() -> AIProjectClient:
    return AIProjectClient.from_connection_string(
        credential=DefaultAzureCredential(),
        conn_str=PROJECT_CONN_STR,
    )


async def run_orchestrator(message: str) -> str:
    """Create an agent, send a message, and return the response."""
    client = _get_client()

    agent = client.agents.create_agent(
        model=os.getenv("AZURE_OPENAI_DEPLOYMENT", "gpt-4o"),
        name="orchestrator",
        instructions=(
            "You are the orchestrator for {{ project_name }}. "
            "Break complex requests into sub-tasks, delegate to specialist "
            "agents (research, summariser), and synthesise a final answer."
        ),
    )

    thread: AgentThread = client.agents.create_thread()

    client.agents.create_message(
        thread_id=thread.id,
        role=MessageRole.USER,
        content=message,
    )

    run = client.agents.create_and_process_run(
        thread_id=thread.id,
        agent_id=agent.id,
    )

    if run.status == "failed":
        return f"Agent run failed: {run.last_error}"

    messages = client.agents.list_messages(thread_id=thread.id)
    for msg in reversed(messages.data):
        if msg.role == MessageRole.AGENT:
            return msg.content[0].text.value

    return "No response from agent."
